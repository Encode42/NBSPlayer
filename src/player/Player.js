import{wait}from"../util/util.js";import{playNote}from"../audio/audio.js";import EventClass from"../util/EventClass.js";const progressBar=document.getElementById("progress-bar"),loopingCheck=document.getElementById("looping-check");let lastProgress=0;export default class Player extends EventClass{name;timePerTick;hasSolo;layers={};audibleLayers=0;stop=!1;currentJob;currentTick=-1;lastTick;updateProgress=!0;loop;maxLoopCount;currentLoopCount=0;loopStartTick;useParity=!0;element;arrayBuffer;instruments;constructor(s){super(),this.hasSolo=s.meta.hasSolo,this.timePerTick=s.timePerTick,this.lastTick=s.length,this.loop=s.loop.enabled,this.maxLoopCount=s.loop.totalLoops,this.loopStartTick=s.loop.startTick;var e=s.layers.length;for(let t=0;t<e;t++){var o=s.layers[t];this.hasSolo&&!o.isSolo||o.isLocked||(this.layers[this.audibleLayers]=o,this.audibleLayers++)}this.instruments=s.instruments.loaded}checkLooping(t){t?(this.loop=!1,loopingCheck.checked=!1,loopingCheck.disabled=!0):(loopingCheck.checked=this.loop,loopingCheck.disabled=!this.loop)}checkProgressBar(){var t;!this.updateProgress||(t=Math.round(this.currentTick/this.lastTick*100*10)/10)!==lastProgress&&(lastProgress=t,progressBar.value=t)}async play(){for(this.stop=!1;!this.stop;)this.currentJob=this.runJob(),await this.currentJob}async runJob(){for(let t=0;t<this.audibleLayers;t++){var e=this.layers[t],o=e.notes[this.currentTick];if(o){let t=(o.panning+e.stereo)/2,s=o.pitch;this.useParity&&(t=0===e.stereo?o.panning:t,s=o.pitch-2),playNote(o.key,this.instruments[o.instrument],o.velocity*e.volume/100,t,s)}}await wait(this.timePerTick),this.currentTick++,this.checkProgressBar(),this.currentTick>this.lastTick&&(this.loop&&(0===this.maxLoopCount||this.maxLoopCount>this.currentLoopCount)?(this.currentLoopCount++,this.currentTick=this.loopStartTick,this.emit("loop")):(this.reset(),this.emit("end")))}async pause(){this.stop=!0,await this.currentJob}async reset(){await this.pause(),this.currentTick=-1,this.currentLoopCount=0,progressBar.value=0}}