import{Player}from"./player/Player.js";import{load,init}from"./audio/load.js";import{resetElements}from"./util/util.js";const params=new URLSearchParams(window.location.search),queryURL=params.get("url");let selectToggle,fileSelect,urlSelectParent,urlSelect,urlSelectLoad,playbackButton,resetButton,progressBar,loopingCheck,parityCheck,currentPlayer;async function fetchURL(e){var t;try{t=new URL(e),urlSelectLoad.dataset.loading="true";const a=await fetch(t);a.ok&&loadSong(t,await a.arrayBuffer()),delete urlSelectLoad.dataset.loading}catch{}}async function loadSong(e,t){await Player.stopAll(),setPlaying(!1);t=await load(e,t);currentPlayer=new Player(t),currentPlayer.checkLooping(),currentPlayer.hasEndListener||(currentPlayer.addEventListener("end",()=>{setPlaying(!1)}),currentPlayer.hasEndListener=!0),setReady(!0)}function setReady(e){e?(playbackButton.disabled=!1,resetButton.disabled=!1,progressBar.disabled=!1,parityCheck.disabled=!1):(playbackButton.disabled=!0,resetButton.disabled=!0,progressBar.disabled=!0,loopingCheck.disabled=!0,parityCheck.disabled=!0)}function setUseURL(e){e?(selectToggle.dataset.toggled="true",fileSelect.classList.add("invisible"),urlSelect.value=null,urlSelectParent.classList.add("visible")):(delete selectToggle.dataset.toggled,fileSelect.classList.remove("invisible"),urlSelectParent.classList.remove("visible"),fileSelect.value=null)}function setPlaying(e){e?(currentPlayer?.play(),playbackButton.dataset.toggled="true"):(currentPlayer?.pause(),delete playbackButton.dataset.toggled)}window.addEventListener("load",async()=>{selectToggle=document.getElementById("select-toggle"),fileSelect=document.getElementById("file-select"),urlSelectParent=document.getElementById("url-select-parent"),urlSelect=document.getElementById("url-select"),urlSelectLoad=document.getElementById("url-select-load"),progressBar=document.getElementById("progress-bar"),playbackButton=document.getElementById("playback-button"),resetButton=document.getElementById("reset-button"),loopingCheck=document.getElementById("looping-check"),parityCheck=document.getElementById("parity-check"),setReady(!1),queryURL&&(setUseURL(!0),urlSelect.dataset.ignore="true",urlSelect.value=queryURL,fetchURL(queryURL)),resetElements(),delete urlSelect.dataset.ignore,await init(),selectToggle.addEventListener("click",()=>{setUseURL("true"!==selectToggle.dataset.toggled),setReady(!1),currentPlayer?.reset()}),urlSelectLoad.addEventListener("click",async()=>{var e=urlSelect.value;await fetchURL(e),params.set("url",e),window.history.replaceState({},"",window.location.pathname+"?"+params.toString())}),fileSelect.addEventListener("change",async()=>{0!==fileSelect.files.length&&loadSong(fileSelect.files[0].name,await fileSelect.files[0].arrayBuffer())}),playbackButton.addEventListener("click",()=>{setPlaying("true"!==playbackButton.dataset.toggled)}),resetButton.addEventListener("click",()=>{currentPlayer.reset(),setPlaying(!1)}),progressBar.addEventListener("mousedown",()=>{currentPlayer.updateProgress=!1}),progressBar.addEventListener("mouseup",()=>{currentPlayer.currentTick=Math.round(progressBar.value/100*currentPlayer.lastTick),currentPlayer.updateProgress=!0}),loopingCheck.addEventListener("change",()=>currentPlayer.loop=loopingCheck.checked),parityCheck.addEventListener("change",()=>currentPlayer.useParity=parityCheck.checked)});